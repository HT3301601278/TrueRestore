<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>真迹还原系统</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.294.0"
        }
      }
    </script>
  </head>

  <body>
    <div id="root"></div>

    <script type="module">
      import React, { useState, useEffect, useRef } from "react";
      import { createRoot } from "react-dom/client";
      import {
        Play,
        Pause,
        SkipBack,
        SkipForward,
        RotateCcw,
        ArrowUp,
        ArrowDown,
        Feather,
        PenTool,
        Sliders,
        Undo,
        Trash2,
        ZoomIn,
        Upload,
        FileText,
        X,
        Download,
        MousePointer2,
        Maximize2,
        Minimize2,
        Edit3,
        Scissors,
        Check,
        GripVertical,
        Merge,
      } from "lucide-react";

      // --- 辅助函数 ---

      const getDistance = (p1, p2) =>
        Math.sqrt(Math.pow(p1[0] - p2[0], 2) + Math.pow(p1[1] - p2[1], 2));

      const perpendicularDistance = (point, lineStart, lineEnd) => {
        let dx = lineEnd[0] - lineStart[0];
        let dy = lineEnd[1] - lineStart[1];
        if (dx === 0 && dy === 0) return getDistance(point, lineStart);
        const mag = dx * dx + dy * dy;
        let u =
          ((point[0] - lineStart[0]) * dx + (point[1] - lineStart[1]) * dy) /
          mag;
        if (u > 1) u = 1;
        else if (u < 0) u = 0;
        const x = lineStart[0] + u * dx;
        const y = lineStart[1] + u * dy;
        return getDistance(point, [x, y]);
      };

      const ramerDouglasPeucker = (points, epsilon) => {
        if (points.length < 3) return points;
        let dmax = 0;
        let index = 0;
        const end = points.length - 1;
        for (let i = 1; i < end; i++) {
          const d = perpendicularDistance(points[i], points[0], points[end]);
          if (d > dmax) {
            index = i;
            dmax = d;
          }
        }
        if (dmax > epsilon) {
          const res1 = ramerDouglasPeucker(points.slice(0, index + 1), epsilon);
          const res2 = ramerDouglasPeucker(
            points.slice(index, end + 1),
            epsilon
          );
          return [...res1.slice(0, -1), ...res2];
        } else {
          return [points[0], points[end]];
        }
      };

      const getSmoothPath = (points) => {
        if (points.length === 0) return "";
        if (points.length === 1) return `M ${points[0][0]} ${points[0][1]}`;
        if (points.length === 2)
          return `M ${points[0][0]} ${points[0][1]} L ${points[1][0]} ${points[1][1]}`;
        let d = `M ${points[0][0]} ${points[0][1]}`;
        for (let i = 1; i < points.length - 1; i++) {
          const p1 = points[i];
          const nextP = points[i + 1];
          const endX = (p1[0] + nextP[0]) / 2;
          const endY = (p1[1] + nextP[1]) / 2;
          d += ` Q ${p1[0]} ${p1[1]} ${endX} ${endY}`;
        }
        const last = points[points.length - 1];
        d += ` L ${last[0]} ${last[1]}`;
        return d;
      };

      const parseSvgFile = (svgContent) => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(svgContent, "image/svg+xml");
        const svgElement = doc.querySelector("svg");
        const viewBox = svgElement?.getAttribute("viewBox");
        const width = svgElement?.getAttribute("width");
        const height = svgElement?.getAttribute("height");
        const pathElements = doc.querySelectorAll("path");
        const paths = [];
        pathElements.forEach((pathEl, index) => {
          const d = pathEl.getAttribute("d");
          const id = pathEl.getAttribute("id") || String(index);
          if (d)
            paths.push({
              id,
              name: `笔画 ${String.fromCharCode(65 + index)}`,
              color: "#000000",
              d,
            });
        });
        return { paths, viewBox, width, height };
      };

      const splitCompoundPath = (d) => {
        const commands = d.split(/(?=[Mm])/).filter((p) => p.trim().length > 0);
        return commands;
      };

      const generateDistinctColors = (count) => {
        const colors = [
          "#ef4444",
          "#3b82f6",
          "#10b981",
          "#f59e0b",
          "#8b5cf6",
          "#ec4899",
        ];
        return Array.from(
          { length: count },
          (_, i) => colors[i % colors.length]
        );
      };

      const calculateFocusViewBox = (d, fallbackViewBox) => {
        const numbers = d.match(/[-+]?[0-9]*\.?[0-9]+/g)?.map(Number);
        if (!numbers || numbers.length === 0) return fallbackViewBox || "";
        let minX = Infinity,
          minY = Infinity,
          maxX = -Infinity,
          maxY = -Infinity;
        for (let i = 0; i < numbers.length; i += 2) {
          if (i + 1 >= numbers.length) break;
          const x = numbers[i];
          const y = numbers[i + 1];
          if (x < minX) minX = x;
          if (x > maxX) maxX = x;
          if (y < minY) minY = y;
          if (y > maxY) maxY = y;
        }
        const width = maxX - minX;
        const height = maxY - minY;
        const padding = Math.max(width, height) * 0.2;
        return `${minX - padding} ${minY - padding} ${width + padding * 2} ${
          height + padding * 2
        }`;
      };

      // --- 组件 ---

      const AnimatedPath = ({
        d,
        color,
        status,
        isPaused,
        totalDurationPerPath,
        id,
        isHovered,
        onHover,
        onLeave,
        recordedStrokeData,
      }) => {
        const strokeRef = useRef(null);
        const [strokeLength, setStrokeLength] = useState(0);
        const strokePath = recordedStrokeData?.d;
        const strokeWidth = recordedStrokeData?.width || 8;

        const displayColor = isHovered ? "#ef4444" : color;

        const isVisible =
          status === "completed" || status === "idle" || isHovered;

        useEffect(() => {
          if (strokeRef.current)
            setStrokeLength(strokeRef.current.getTotalLength());
        }, [strokePath]);

        const maskId = `mask-${id}`;

        if (strokePath) {
          return React.createElement(
            "g",
            null,
            React.createElement(
              "defs",
              null,
              React.createElement(
                "mask",
                { id: maskId, maskUnits: "userSpaceOnUse" },
                React.createElement("path", {
                  ref: strokeRef,
                  d: strokePath,
                  stroke: "white",
                  strokeWidth: strokeWidth,
                  strokeLinecap: "round",
                  strokeLinejoin: "round",
                  fill: "none",
                  strokeDasharray: strokeLength,

                  strokeDashoffset: isVisible ? 0 : strokeLength,
                  style: {
                    animation:
                      status === "animating"
                        ? `dash ${totalDurationPerPath}ms ease-out forwards`
                        : "none",
                    animationPlayState: isPaused ? "paused" : "running",
                  },
                })
              )
            ),
            React.createElement("path", {
              d: d,
              fill: displayColor,
              mask: `url(#${maskId})`,
              onMouseEnter: () => onHover(id),
              onMouseLeave: onLeave,
              style: {
                cursor: "pointer",

                opacity: status === "waiting" && !isHovered ? 0 : 1,
                transition: "fill 0.2s, opacity 0.3s",
              },
            }),
            isHovered &&
              status !== "animating" &&
              React.createElement("path", {
                d: strokePath,
                stroke: "red",
                strokeWidth: 1,
                fill: "none",
                opacity: "0.3",
              })
          );
        }

        return React.createElement("path", {
          d: d,
          fill: displayColor,
          onMouseEnter: () => onHover(id),
          onMouseLeave: onLeave,
          style: {
            opacity: isVisible ? 1 : 0,
            animation:
              status === "animating"
                ? `fadeIn ${totalDurationPerPath}ms ease-out forwards`
                : "none",
            animationPlayState: isPaused ? "paused" : "running",
            transition: "fill 0.2s, opacity 0.3s",
          },
        });
      };

      function App() {
        // --- 核心状态 ---
        const [paths, setPaths] = useState([]);
        const [recordedStrokes, setRecordedStrokes] = useState({});

        // --- 播放状态 ---
        const [isPlaying, setIsPlaying] = useState(false);
        const [currentStep, setCurrentStep] = useState(-1);

        // --- UI 状态 ---
        const [hoveredId, setHoveredId] = useState(null);
        const [svgInfo, setSvgInfo] = useState({
          viewBox: null,
          width: null,
          height: null,
        });
        const [uploadedFileName, setUploadedFileName] = useState("");

        // --- 录制相关状态 ---
        const [recordingId, setRecordingId] = useState(null);
        const [recordingViewBox, setRecordingViewBox] = useState(null);
        const [brushSize, setBrushSize] = useState(8);
        const [draftStrokes, setDraftStrokes] = useState([]);
        const [activeStrokePoints, setActiveStrokePoints] = useState([]);
        const [isDrawing, setIsDrawing] = useState(false);
        const [draggingInfo, setDraggingInfo] = useState(null);
        const [isFullScreen, setIsFullScreen] = useState(false);

        // --- 拆分相关状态 ---
        const [splittingId, setSplittingId] = useState(null);
        const [splitDraft, setSplitDraft] = useState([]);
        const [selectedSplitIds, setSelectedSplitIds] = useState([]);

        const fileInputRef = useRef(null);
        const svgRef = useRef(null);

        const DURATION_PER_PATH = 1000;
        const DELAY_BETWEEN = 200;

        // --- 播放逻辑 ---
        useEffect(() => {
          let timer;
          if (isPlaying && currentStep < paths.length) {
            if (currentStep === -1) {
              setCurrentStep(0);
            } else {
              timer = setTimeout(() => {
                setCurrentStep((prev) => {
                  if (prev >= paths.length - 1) {
                    setIsPlaying(false);
                    return prev;
                  }
                  return prev + 1;
                });
              }, DURATION_PER_PATH + DELAY_BETWEEN);
            }
          }
          return () => clearTimeout(timer);
        }, [isPlaying, currentStep, paths.length]);

        const handlePlayPause = () => {
          if (paths.length === 0) return;
          if (currentStep >= paths.length - 1 && !isPlaying) {
            setCurrentStep(0);
          } else if (currentStep === -1) {
            setCurrentStep(0);
          }
          setIsPlaying(!isPlaying);
        };

        const handlePrevStep = () => {
          setIsPlaying(false);
          setCurrentStep((prev) => Math.max(0, prev - 1));
        };

        const handleNextStep = () => {
          setIsPlaying(false);
          setCurrentStep((prev) => Math.min(paths.length - 1, prev + 1));
        };

        const handleReset = () => {
          setIsPlaying(false);
          setCurrentStep(-1);
        };

        // --- 文件处理 ---
        const handleFileUpload = (event) => {
          const file = event.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            const content = e.target?.result;
            if (typeof content === "string") {
              if (file.name.endsWith(".json")) {
                try {
                  const projectData = JSON.parse(content);
                  if (
                    projectData.type === "trace-restore-project" &&
                    projectData.paths
                  ) {
                    setPaths(projectData.paths);
                    setRecordedStrokes(projectData.recordedStrokes || {});
                    setSvgInfo(projectData.svgInfo);
                    setUploadedFileName(file.name.replace(".json", ""));
                    handleReset();
                  } else {
                    alert("无效的项目文件格式");
                  }
                } catch (err) {
                  alert("JSON 文件解析失败");
                }
              } else {
                const {
                  paths: parsedPaths,
                  viewBox,
                  width,
                  height,
                } = parseSvgFile(content);
                if (parsedPaths.length > 0) {
                  setPaths(parsedPaths);
                  setSvgInfo({ viewBox, width, height });
                  setUploadedFileName(file.name);
                  setRecordedStrokes({});
                  handleReset();
                } else {
                  alert("未能解析 SVG");
                }
              }
            }
          };
          reader.readAsText(file);
          event.target.value = "";
        };

        const handleExport = () => {
          const projectData = {
            type: "trace-restore-project",
            timestamp: new Date().toISOString(),
            svgInfo,
            paths,
            recordedStrokes,
          };
          const blob = new Blob([JSON.stringify(projectData, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${uploadedFileName || "trace"}_saved.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };

        const clearUploadedFile = () => {
          setPaths([]);
          setSvgInfo({ viewBox: null, width: null, height: null });
          setUploadedFileName("");
          setRecordedStrokes({});
          handleReset();
        };

        // --- 录制逻辑 ---
        const startRecording = (id) => {
          setRecordingId(id);
          setIsDrawing(false);
          setDraggingInfo(null);

          const targetPath = paths.find((p) => p.id === id);
          let computedBox = null;

          if (targetPath) {
            computedBox = calculateFocusViewBox(targetPath.d, svgInfo.viewBox);
            setRecordingViewBox(computedBox);
          }

          const prev = recordedStrokes[id];
          if (prev) {
            if (prev.width) setBrushSize(prev.width);
            if (prev.rawStrokes && prev.rawStrokes.length > 0) {
              setDraftStrokes(prev.rawStrokes);
            } else {
              setDraftStrokes([]);
            }
          } else {
            let autoSize = 8;
            if (computedBox) {
              const parts = computedBox.split(" ");
              if (parts.length === 4) {
                const w = parseFloat(parts[2]);
                autoSize = Math.max(2, Math.round(w / 30));
              }
            }
            setBrushSize(autoSize);
            setDraftStrokes([]);
          }
          setIsPlaying(false);
        };

        const cancelRecording = () => {
          setRecordingId(null);
          setDraftStrokes([]);
          setActiveStrokePoints([]);
          setIsDrawing(false);
          setDraggingInfo(null);
          setIsFullScreen(false);
        };

        const undoLastStroke = () =>
          setDraftStrokes((prev) => prev.slice(0, -1));
        const clearRecording = () => setDraftStrokes([]);

        const saveRecording = () => {
          const fullPath = draftStrokes.map((s) => s.d).join(" ");
          if (!fullPath.trim()) return;

          setRecordedStrokes((prev) => ({
            ...prev,
            [recordingId]: {
              d: fullPath,
              width: brushSize,
              rawStrokes: draftStrokes,
            },
          }));
          setRecordingId(null);
          setDraftStrokes([]);
          setActiveStrokePoints([]);
          setIsFullScreen(false);
        };

        const getRelativeCoordinates = (e) => {
          const svg = svgRef.current;
          const pt = svg.createSVGPoint();
          pt.x = e.clientX || e.touches?.[0]?.clientX;
          pt.y = e.clientY || e.touches?.[0]?.clientY;
          const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
          return [Number(svgP.x.toFixed(2)), Number(svgP.y.toFixed(2))];
        };

        const handlePointerDown = (e) => {
          if (!recordingId || !svgRef.current) return;
          const pt = getRelativeCoordinates(e);
          const hitRadius =
            parseFloat(recordingViewBox.split(" ")[2]) / 40 || 5;
          let foundHit = null;
          for (let i = draftStrokes.length - 1; i >= 0; i--) {
            const points = draftStrokes[i].points;
            for (let j = 0; j < points.length; j++) {
              if (getDistance(pt, points[j]) < hitRadius) {
                foundHit = { strokeIndex: i, pointIndex: j };
                break;
              }
            }
            if (foundHit) break;
          }
          if (foundHit) {
            setDraggingInfo(foundHit);
            e.target.setPointerCapture(e.pointerId);
          } else {
            setIsDrawing(true);
            setActiveStrokePoints([pt]);
            e.target.setPointerCapture(e.pointerId);
          }
        };

        const handlePointerMove = (e) => {
          if (!recordingId || !svgRef.current) return;
          const pt = getRelativeCoordinates(e);
          if (draggingInfo) {
            setDraftStrokes((prev) => {
              const newStrokes = [...prev];
              const stroke = { ...newStrokes[draggingInfo.strokeIndex] };
              const newPoints = [...stroke.points];
              newPoints[draggingInfo.pointIndex] = pt;
              stroke.points = newPoints;
              stroke.d = getSmoothPath(newPoints);
              newStrokes[draggingInfo.strokeIndex] = stroke;
              return newStrokes;
            });
          } else if (isDrawing) {
            setActiveStrokePoints((prev) => [...prev, pt]);
          }
        };

        const handlePointerUp = (e) => {
          if (!recordingId) return;
          e.target.releasePointerCapture(e.pointerId);
          if (draggingInfo) {
            setDraggingInfo(null);
          } else if (isDrawing) {
            setIsDrawing(false);
            if (activeStrokePoints.length > 1) {
              const simplePoints = ramerDouglasPeucker(activeStrokePoints, 2.0);
              const smoothD = getSmoothPath(simplePoints);
              setDraftStrokes((prev) => [
                ...prev,
                { points: simplePoints, d: smoothD },
              ]);
            }
            setActiveStrokePoints([]);
          }
        };

        const handlePointDoubleClick = (strokeIndex, pointIndex, e) => {
          e.stopPropagation();
          e.preventDefault();
          setDraftStrokes((prev) => {
            const newStrokes = [...prev];
            const stroke = { ...newStrokes[strokeIndex] };
            if (stroke.points.length <= 2) return prev;
            const newPoints = stroke.points.filter(
              (_, idx) => idx !== pointIndex
            );
            stroke.points = newPoints;
            stroke.d = getSmoothPath(newPoints);
            newStrokes[strokeIndex] = stroke;
            return newStrokes;
          });
        };

        const handleStrokeDoubleClick = (strokeIndex, e) => {
          e.stopPropagation();
          e.preventDefault();
          const pt = getRelativeCoordinates(e);
          setDraftStrokes((prev) => {
            const newStrokes = [...prev];
            const stroke = { ...newStrokes[strokeIndex] };
            const points = stroke.points;
            let minInfo = { dist: Infinity, index: 0 };
            for (let i = 0; i < points.length - 1; i++) {
              const d = perpendicularDistance(pt, points[i], points[i + 1]);
              const len = getDistance(points[i], points[i + 1]);
              const d1 = getDistance(pt, points[i]);
              const d2 = getDistance(pt, points[i + 1]);
              if (d < minInfo.dist && d1 + d2 < len * 1.5) {
                minInfo = { dist: d, index: i + 1 };
              }
            }
            if (minInfo.dist < Infinity) {
              const newPoints = [...points];
              newPoints.splice(minInfo.index, 0, pt);
              stroke.points = newPoints;
              stroke.d = getSmoothPath(newPoints);
              newStrokes[strokeIndex] = stroke;
              return newStrokes;
            }
            return prev;
          });
        };

        // --- 拆分与合并逻辑 ---

        const startSplitting = (pathId) => {
          const path = paths.find((p) => p.id === pathId);
          if (!path) return;
          const subPathStrings = splitCompoundPath(path.d);
          if (subPathStrings.length <= 1) return;

          const distinctColors = generateDistinctColors(subPathStrings.length);
          const initialSplitDraft = subPathStrings.map((dStr, idx) => ({
            id: `${pathId}_split_${Date.now()}_${idx}`,
            d: dStr,
            splitColor: distinctColors[idx],
          }));

          setSplittingId(pathId);
          setSplitDraft(initialSplitDraft);
          setSelectedSplitIds([]);
        };

        const toggleSplitSelection = (id) => {
          setSelectedSplitIds((prev) =>
            prev.includes(id) ? prev.filter((pid) => pid !== id) : [...prev, id]
          );
        };

        const mergeSelectedSplits = () => {
          if (selectedSplitIds.length < 2) return;

          const indices = splitDraft
            .map((item, index) =>
              selectedSplitIds.includes(item.id) ? index : -1
            )
            .filter((i) => i !== -1)
            .sort((a, b) => a - b);

          if (indices.length === 0) return;

          const selectedItems = indices.map((i) => splitDraft[i]);
          const combinedD = selectedItems.map((item) => item.d).join(" ");
          const firstIndex = indices[0];

          const newItem = {
            id: `${splittingId}_merged_${Date.now()}`,
            d: combinedD,
            splitColor: selectedItems[0].splitColor,
          };

          const newDraft = [...splitDraft];

          for (let i = indices.length - 1; i >= 0; i--) {
            newDraft.splice(indices[i], 1);
          }

          newDraft.splice(firstIndex, 0, newItem);

          setSplitDraft(newDraft);
          setSelectedSplitIds([]);
        };

        const handleSplitReorder = (index, direction) => {
          const newDraft = [...splitDraft];
          if (direction === "up" && index > 0) {
            [newDraft[index], newDraft[index - 1]] = [
              newDraft[index - 1],
              newDraft[index],
            ];
          } else if (direction === "down" && index < newDraft.length - 1) {
            [newDraft[index], newDraft[index + 1]] = [
              newDraft[index + 1],
              newDraft[index],
            ];
          }
          setSplitDraft(newDraft);
        };

        const confirmSplit = () => {
          const originalIndex = paths.findIndex((p) => p.id === splittingId);
          if (originalIndex === -1) return;
          const originalPath = paths[originalIndex];

          const newPaths = splitDraft.map((item, idx) => ({
            id: `${originalPath.id}_part_${idx + 1}`,
            name: `${originalPath.name}.${idx + 1}`,
            color: originalPath.color,
            d: item.d,
          }));

          const updatedPaths = [...paths];
          updatedPaths.splice(originalIndex, 1, ...newPaths);

          const updatedRecordings = { ...recordedStrokes };
          delete updatedRecordings[splittingId];

          setPaths(updatedPaths);
          setRecordedStrokes(updatedRecordings);
          setSplittingId(null);
          setSplitDraft([]);
          setSelectedSplitIds([]);

          setCurrentStep(-1);
          setIsPlaying(false);
        };

        const handleReorder = (index, direction) => {
          if (isPlaying) return;
          const newPaths = [...paths];
          if (direction === "up" && index > 0) {
            [newPaths[index], newPaths[index - 1]] = [
              newPaths[index - 1],
              newPaths[index],
            ];
          } else if (direction === "down" && index < newPaths.length - 1) {
            [newPaths[index], newPaths[index + 1]] = [
              newPaths[index + 1],
              newPaths[index],
            ];
          }
          setPaths(newPaths);
        };

        // --- 渲染 ---

        const h = React.createElement;
        const controlPointSize = recordingViewBox
          ? parseFloat(recordingViewBox.split(" ")[2]) / 120
          : 1;

        return h(
          "div",
          {
            className:
              "flex flex-col items-center justify-center h-screen bg-stone-100 p-4 font-sans text-stone-800 select-none overflow-hidden",
          },
          h(
            "style",
            null,
            `
                    @keyframes dash { to { stroke-dashoffset: 0; } }
                    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                `
          ),

          // --- 拆分弹窗 ---
          splittingId &&
            h(
              "div",
              {
                className:
                  "fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/70 backdrop-blur-sm",
              },
              h(
                "div",
                {
                  className:
                    "bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden",
                },

                h(
                  "div",
                  {
                    className:
                      "p-4 border-b border-stone-200 flex justify-between items-center bg-stone-50",
                  },
                  h(
                    "div",
                    { className: "flex items-center gap-4" },
                    h(
                      "h3",
                      {
                        className:
                          "text-lg font-bold flex items-center gap-2 text-stone-700",
                      },
                      h(Scissors, { size: 20 }),
                      "拆分与排序"
                    ),

                    h(
                      "button",
                      {
                        onClick: mergeSelectedSplits,
                        disabled: selectedSplitIds.length < 2,
                        className: `px-3 py-1.5 text-xs font-bold rounded flex items-center gap-1 transition-all ${
                          selectedSplitIds.length >= 2
                            ? "bg-amber-100 text-amber-700 hover:bg-amber-200"
                            : "bg-stone-100 text-stone-300 cursor-not-allowed"
                        }`,
                      },
                      h(Merge, { size: 14 }),
                      `合并选中 (${selectedSplitIds.length})`
                    )
                  ),
                  h(
                    "div",
                    { className: "flex gap-2" },
                    h(
                      "button",
                      {
                        onClick: () => setSplittingId(null),
                        className:
                          "px-4 py-2 text-stone-500 hover:bg-stone-200 rounded-lg font-medium",
                      },
                      "取消"
                    ),
                    h(
                      "button",
                      {
                        onClick: confirmSplit,
                        className:
                          "px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg font-bold flex items-center gap-2",
                      },
                      h(Check, { size: 18 }),
                      "确认拆分"
                    )
                  )
                ),
                h(
                  "div",
                  { className: "flex-1 flex overflow-hidden" },

                  h(
                    "div",
                    {
                      className:
                        "w-1/3 border-r border-stone-200 bg-stone-50 overflow-y-auto p-4 flex flex-col gap-3",
                    },
                    h(
                      "div",
                      {
                        className:
                          "text-sm text-stone-500 mb-2 flex justify-between items-center",
                      },
                      h("span", null, "勾选以合并，点击箭头以调整排序："),
                      selectedSplitIds.length > 0 &&
                        h(
                          "button",
                          {
                            className:
                              "text-xs text-indigo-500 hover:underline px-2",
                            onClick: () => setSelectedSplitIds([]),
                          },
                          "取消选择"
                        )
                    ),
                    splitDraft.map((item, idx) =>
                      h(
                        "div",
                        {
                          key: item.id,
                          className: `bg-white p-3 rounded-xl border-2 shadow-sm flex items-center justify-between transition-colors ${
                            selectedSplitIds.includes(item.id)
                              ? "bg-indigo-50 border-indigo-300"
                              : ""
                          }`,
                          style: {
                            borderColor: selectedSplitIds.includes(item.id)
                              ? undefined
                              : item.splitColor,
                          },
                        },
                        h(
                          "div",
                          { className: "flex items-center gap-3" },

                          h("input", {
                            type: "checkbox",
                            checked: selectedSplitIds.includes(item.id),
                            onChange: () => toggleSplitSelection(item.id),
                            className:
                              "w-4 h-4 rounded border-stone-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer",
                          }),
                          h(
                            "div",
                            {
                              className:
                                "w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white",
                              style: { backgroundColor: item.splitColor },
                            },
                            idx + 1
                          ),
                          h(
                            "span",
                            { className: "font-medium text-sm text-stone-700" },
                            `片段 ${idx + 1}`
                          )
                        ),
                        h(
                          "div",
                          { className: "flex flex-col gap-1" },
                          h(
                            "button",
                            {
                              onClick: () => handleSplitReorder(idx, "up"),
                              disabled: idx === 0,
                              className:
                                "p-1 hover:bg-stone-100 rounded text-stone-500 disabled:opacity-20",
                            },
                            h(ArrowUp, { size: 14 })
                          ),
                          h(
                            "button",
                            {
                              onClick: () => handleSplitReorder(idx, "down"),
                              disabled: idx === splitDraft.length - 1,
                              className:
                                "p-1 hover:bg-stone-100 rounded text-stone-500 disabled:opacity-20",
                            },
                            h(ArrowDown, { size: 14 })
                          )
                        )
                      )
                    )
                  ),

                  h(
                    "div",
                    {
                      className:
                        "w-2/3 bg-stone-100 flex items-center justify-center p-8 relative",
                    },
                    h(
                      "div",
                      {
                        className:
                          "absolute top-4 left-4 bg-white/80 p-2 rounded text-xs text-stone-500",
                      },
                      "预览区：不同颜色代表拆分后的不同片段"
                    ),
                    h(
                      "svg",
                      {
                        viewBox: calculateFocusViewBox(
                          splitDraft.map((s) => s.d).join(" "),
                          svgInfo.viewBox
                        ),
                        className:
                          "w-full h-full max-h-[500px] overflow-visible drop-shadow-xl",
                      },
                      splitDraft.map((item, idx) =>
                        h("path", {
                          key: item.id,
                          d: item.d,
                          fill: item.splitColor,
                          stroke: "white",
                          strokeWidth: 0.5,
                          className: `transition-all duration-300 ${
                            selectedSplitIds.includes(item.id)
                              ? "opacity-100 stroke-indigo-500 stroke-2"
                              : "opacity-90"
                          }`,
                        })
                      )
                    )
                  )
                )
              )
            ),

          // --- 录制弹窗 ---
          recordingId &&
            h(
              "div",
              {
                className: `fixed inset-0 z-50 flex flex-col items-center justify-center backdrop-blur-sm transition-all duration-300 ${
                  isFullScreen ? "bg-white" : "bg-black/80"
                }`,
              },
              h(
                "div",
                {
                  className: `bg-white flex flex-col transition-all duration-300 ${
                    isFullScreen
                      ? "w-full h-full rounded-none p-4"
                      : "p-6 rounded-2xl shadow-2xl max-w-lg w-full"
                  }`,
                },

                h(
                  "div",
                  {
                    className:
                      "flex justify-between items-center mb-4 shrink-0",
                  },
                  h(
                    "h3",
                    { className: "text-xl font-bold flex items-center gap-2" },
                    h(ZoomIn, { className: "text-indigo-500" }),
                    `编辑: ${paths.find((p) => p.id === recordingId)?.name}`
                  ),
                  h(
                    "div",
                    { className: "space-x-2 flex items-center" },
                    h(
                      "button",
                      {
                        onClick: () => setIsFullScreen(!isFullScreen),
                        className:
                          "p-2 text-slate-500 hover:bg-slate-100 rounded",
                        title: isFullScreen ? "退出全屏" : "全屏模式",
                      },
                      isFullScreen
                        ? h(Minimize2, { size: 20 })
                        : h(Maximize2, { size: 20 })
                    ),
                    h("div", { className: "w-px h-6 bg-slate-200 mx-1" }),
                    h(
                      "button",
                      {
                        onClick: undoLastStroke,
                        disabled: draftStrokes.length === 0,
                        className:
                          "px-3 py-1 text-slate-500 hover:bg-slate-100 rounded disabled:opacity-30",
                        title: "撤销",
                      },
                      h(Undo, { size: 18 })
                    ),
                    h(
                      "button",
                      {
                        onClick: clearRecording,
                        disabled: draftStrokes.length === 0,
                        className:
                          "px-3 py-1 text-slate-500 hover:bg-slate-100 rounded disabled:opacity-30",
                        title: "清空",
                      },
                      h(Trash2, { size: 18 })
                    ),
                    h(
                      "button",
                      {
                        onClick: cancelRecording,
                        className:
                          "px-3 py-1 text-slate-500 hover:bg-slate-100 rounded",
                      },
                      "取消"
                    ),
                    h(
                      "button",
                      {
                        onClick: saveRecording,
                        className:
                          "px-4 py-1 bg-indigo-600 text-white rounded shadow hover:bg-indigo-700 font-bold",
                      },
                      "保存"
                    )
                  )
                ),

                h(
                  "div",
                  {
                    className:
                      "mb-2 bg-indigo-50 p-2 rounded-lg border border-indigo-100 flex flex-wrap gap-4 shrink-0 text-xs items-center",
                  },
                  h(
                    "div",
                    { className: "flex items-center gap-2" },
                    h(MousePointer2, {
                      size: 14,
                      className: "text-indigo-600",
                    }),
                    h(
                      "span",
                      { className: "text-indigo-800 font-medium" },
                      "操作提示："
                    ),
                    h(
                      "span",
                      { className: "text-indigo-600" },
                      "拖动微调 | 双击点=删除 | 双击线=加点"
                    )
                  ),
                  h(
                    "div",
                    {
                      className: "flex items-center gap-2 flex-1 min-w-[150px]",
                    },
                    h(
                      "label",
                      {
                        className:
                          "font-bold text-slate-500 uppercase flex items-center gap-1 shrink-0",
                      },
                      h(Sliders, { size: 12 }),
                      " 笔刷"
                    ),
                    h("input", {
                      type: "range",
                      min: "1",
                      max: "10",
                      step: "0.5",
                      value: brushSize,
                      onChange: (e) => setBrushSize(parseFloat(e.target.value)),
                      className:
                        "w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600",
                    }),
                    h(
                      "span",
                      {
                        className:
                          "font-mono bg-white px-2 rounded border w-8 text-center",
                      },
                      brushSize
                    )
                  )
                ),

                h(
                  "div",
                  {
                    className: `border-2 border-dashed border-indigo-200 rounded-xl bg-white flex justify-center p-0 relative overflow-hidden cursor-crosshair flex-1 transition-all ${
                      isFullScreen ? "h-full" : "h-[300px]"
                    }`,
                  },
                  h(
                    "svg",
                    {
                      ref: svgRef,
                      viewBox: recordingViewBox,
                      width: "100%",
                      height: "100%",
                      preserveAspectRatio: "xMidYMid meet",
                      className: "overflow-visible touch-none",
                      style: { background: "#f8fafc" },
                      onPointerDown: handlePointerDown,
                      onPointerMove: handlePointerMove,
                      onPointerUp: handlePointerUp,
                      onPointerLeave: handlePointerUp,
                    },
                    h("path", {
                      d: paths.find((p) => p.id === recordingId)?.d,
                      fill: "#e5e7eb",
                    }),
                    draftStrokes.map((strokeObj, i) =>
                      h(
                        "g",
                        { key: i },
                        h("path", {
                          d: strokeObj.d,
                          fill: "none",
                          stroke: "transparent",
                          strokeWidth: Math.max(brushSize * 2, 20),
                          className: "cursor-copy",
                          onDoubleClick: (e) => handleStrokeDoubleClick(i, e),
                        }),
                        h("path", {
                          d: strokeObj.d,
                          fill: "none",
                          stroke: "rgba(79, 70, 229, 0.8)",
                          strokeWidth: brushSize,
                          strokeLinecap: "round",
                          strokeLinejoin: "round",
                          className: "pointer-events-none",
                        }),
                        !isDrawing &&
                          strokeObj.points.map((pt, ptIdx) =>
                            h("circle", {
                              key: ptIdx,
                              cx: pt[0],
                              cy: pt[1],
                              r: controlPointSize,
                              fill: "#3b82f6",
                              stroke: "white",
                              strokeWidth: controlPointSize / 3,
                              className:
                                "hover:fill-red-500 cursor-move transition-colors",
                              style: {
                                filter:
                                  "drop-shadow(0 1px 1px rgba(0,0,0,0.2))",
                              },
                              onDoubleClick: (e) =>
                                handlePointDoubleClick(i, ptIdx, e),
                            })
                          )
                      )
                    ),
                    isDrawing &&
                      h("path", {
                        d:
                          activeStrokePoints.length > 0
                            ? `M ${activeStrokePoints[0][0]} ${activeStrokePoints[0][1]}` +
                              activeStrokePoints
                                .slice(1)
                                .map((p) => ` L ${p[0]} ${p[1]}`)
                                .join("")
                            : "",
                        fill: "none",
                        stroke: "rgba(239, 68, 68, 0.6)",
                        strokeWidth: brushSize,
                        strokeLinecap: "round",
                        strokeLinejoin: "round",
                      })
                  )
                )
              )
            ),

          // --- 主界面 ---
          h(
            "div",
            {
              className:
                "w-full max-w-[1600px] h-[75vh] grid grid-cols-1 lg:grid-cols-3 gap-6",
            },
            h(
              "div",
              {
                className:
                  "lg:col-span-1 bg-white rounded-2xl shadow-xl p-6 border border-stone-200 flex flex-col h-full overflow-hidden",
              },
              h(
                "div",
                {
                  className: "flex items-center justify-between mb-6 shrink-0",
                },
                h(
                  "h2",
                  {
                    className:
                      "text-2xl font-serif font-bold text-stone-800 flex items-center gap-2",
                  },
                  h(Feather, { className: "w-6 h-6 text-stone-600" }),
                  "真迹还原系统"
                )
              ),
              h(
                "div",
                { className: "mb-6 shrink-0" },
                h("input", {
                  ref: fileInputRef,
                  type: "file",
                  accept: ".svg,.txt,.json",
                  onChange: handleFileUpload,
                  className: "hidden",
                }),
                paths.length === 0
                  ? h(
                      "div",
                      {
                        onClick: () => fileInputRef.current?.click(),
                        className:
                          "border-2 border-dashed border-indigo-300 rounded-xl p-8 text-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-50/50 transition-all group",
                      },
                      h(Upload, {
                        className:
                          "w-12 h-12 mx-auto mb-3 text-indigo-400 group-hover:text-indigo-600 transition-colors",
                      }),
                      h(
                        "p",
                        { className: "text-stone-600 font-medium" },
                        "点击上传文件"
                      ),
                      h(
                        "p",
                        { className: "text-stone-400 text-sm mt-1" },
                        "支持 .svg 图像 或 .json 项目文件"
                      )
                    )
                  : h(
                      "div",
                      { className: "flex flex-col gap-2" },
                      h(
                        "div",
                        {
                          className:
                            "bg-green-50 border border-green-200 rounded-xl p-4 flex items-center justify-between",
                        },
                        h(
                          "div",
                          { className: "flex items-center gap-3" },
                          h(
                            "div",
                            {
                              className:
                                "w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center",
                            },
                            h(FileText, { className: "w-5 h-5 text-green-600" })
                          ),
                          h(
                            "div",
                            null,
                            h(
                              "p",
                              {
                                className: "text-sm font-medium text-green-800",
                              },
                              uploadedFileName
                            ),
                            h(
                              "p",
                              { className: "text-xs text-green-600" },
                              `已加载 ${paths.length} 个笔画`
                            )
                          )
                        ),
                        h(
                          "div",
                          { className: "flex gap-2" },
                          h(
                            "button",
                            {
                              onClick: () => fileInputRef.current?.click(),
                              className:
                                "px-3 py-1.5 text-sm bg-white border border-green-300 text-green-700 rounded-lg hover:bg-green-50 transition-colors",
                            },
                            "更换"
                          ),
                          h(
                            "button",
                            {
                              onClick: clearUploadedFile,
                              className:
                                "p-1.5 text-green-600 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors",
                            },
                            h(X, { size: 18 })
                          )
                        )
                      ),
                      Object.keys(recordedStrokes).length > 0 &&
                        h(
                          "button",
                          {
                            onClick: handleExport,
                            className:
                              "w-full flex items-center justify-center gap-2 py-2 bg-stone-100 text-stone-600 border border-stone-200 rounded-xl hover:bg-stone-200 transition-colors text-sm font-bold",
                          },
                          h(Download, { size: 16 }),
                          "保存当前进度 (.json)"
                        )
                    )
              ),
              h(
                "div",
                { className: "flex-1 overflow-y-auto px-2" },
                paths.length > 0 &&
                  h(
                    React.Fragment,
                    null,
                    h(
                      "div",
                      { className: "flex justify-between items-end mb-2" },
                      h(
                        "h3",
                        {
                          className:
                            "text-xs font-bold text-stone-500 uppercase tracking-wider",
                        },
                        "字形列表 & 录制"
                      ),
                      h(
                        "span",
                        { className: "text-xs text-stone-400" },
                        `已录制: ${Object.keys(recordedStrokes).length} / ${
                          paths.length
                        }`
                      )
                    ),
                    h(
                      "div",
                      { className: "space-y-3 mb-8" },
                      paths.map((path, index) => {
                        const hasRecording = !!recordedStrokes[path.id];
                        const isCurrent = index === currentStep;
                        const canSplit = splitCompoundPath(path.d).length > 1;

                        return h(
                          "div",
                          {
                            key: path.id,
                            className: `flex items-center justify-between p-3 rounded-xl border transition-all ${
                              isCurrent
                                ? "border-indigo-500 bg-indigo-50 shadow-md ring-1 ring-indigo-500"
                                : hoveredId === path.id
                                ? "border-stone-400 bg-stone-100"
                                : "border-stone-100 bg-white hover:border-stone-300"
                            }`,
                            onMouseEnter: () => setHoveredId(path.id),
                            onMouseLeave: () => setHoveredId(null),
                          },
                          h(
                            "div",
                            { className: "flex items-center space-x-3" },
                            h(
                              "div",
                              {
                                className: `w-8 h-8 rounded-full flex items-center justify-center font-serif font-bold text-sm text-white ${
                                  isCurrent
                                    ? "bg-indigo-600"
                                    : hasRecording
                                    ? "bg-green-500"
                                    : "bg-stone-300"
                                }`,
                              },
                              hasRecording
                                ? "✓"
                                : String.fromCharCode(65 + index)
                            ),
                            h(
                              "div",
                              { className: "flex flex-col" },
                              h(
                                "span",
                                {
                                  className:
                                    "font-medium text-stone-700 font-serif",
                                },
                                path.name
                              ),
                              h(
                                "span",
                                { className: "text-[10px] text-stone-400" },
                                hasRecording ? "已就绪" : "等待录制..."
                              )
                            )
                          ),
                          h(
                            "div",
                            { className: "flex items-center space-x-1" },

                            canSplit &&
                              h(
                                "button",
                                {
                                  onClick: () => startSplitting(path.id),
                                  className:
                                    "p-1.5 rounded text-amber-500 hover:bg-amber-50 border border-transparent hover:border-amber-200 mr-1",
                                  title: "拆分复合笔画",
                                },
                                h(Scissors, { size: 14 })
                              ),

                            h(
                              "button",
                              {
                                onClick: () => startRecording(path.id),
                                className: `flex items-center gap-1 px-2 py-1.5 rounded text-xs font-bold transition-colors ${
                                  hasRecording
                                    ? "bg-white border border-stone-200 text-stone-600 hover:bg-stone-50"
                                    : "bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-indigo-200"
                                }`,
                              },
                              hasRecording
                                ? h(Edit3, { size: 12 })
                                : h(PenTool, { size: 12 }),
                              hasRecording ? "编辑" : "录制"
                            ),
                            h("div", {
                              className: "w-px h-6 bg-stone-200 mx-1",
                            }),
                            h(
                              "button",
                              {
                                onClick: () => handleReorder(index, "up"),
                                disabled: index === 0 || isPlaying,
                                className:
                                  "p-1.5 rounded hover:bg-stone-200 disabled:opacity-30 text-stone-500",
                              },
                              h(ArrowUp, { size: 14 })
                            ),
                            h(
                              "button",
                              {
                                onClick: () => handleReorder(index, "down"),
                                disabled:
                                  index === paths.length - 1 || isPlaying,
                                className:
                                  "p-1.5 rounded hover:bg-stone-200 disabled:opacity-30 text-stone-500",
                              },
                              h(ArrowDown, { size: 14 })
                            )
                          )
                        );
                      })
                    )
                  )
              ),
              h(
                "div",
                {
                  className: "mt-auto pt-6 border-t border-stone-200 shrink-0",
                },
                h(
                  "div",
                  {
                    className:
                      "flex items-center justify-between gap-4 bg-stone-100 p-2 rounded-xl",
                  },

                  h(
                    "button",
                    {
                      onClick: handleReset,
                      disabled: paths.length === 0,
                      className:
                        "p-3 text-stone-500 hover:bg-stone-200 rounded-lg transition-colors disabled:opacity-30",
                      title: "重置",
                    },
                    h(RotateCcw, { size: 20 })
                  ),

                  h(
                    "div",
                    { className: "flex items-center gap-2" },
                    h(
                      "button",
                      {
                        onClick: handlePrevStep,
                        disabled: paths.length === 0 || currentStep <= 0,
                        className:
                          "p-3 text-stone-600 hover:bg-white hover:shadow-sm rounded-lg transition-all disabled:opacity-30",
                      },
                      h(SkipBack, { size: 24 })
                    ),

                    h(
                      "button",
                      {
                        onClick: handlePlayPause,
                        disabled: paths.length === 0,
                        className: `w-16 h-16 flex items-center justify-center rounded-full text-white shadow-lg transition-all transform hover:scale-105 active:scale-95 ${
                          paths.length === 0
                            ? "bg-stone-300"
                            : isPlaying
                            ? "bg-amber-500 hover:bg-amber-600"
                            : "bg-indigo-600 hover:bg-indigo-700"
                        }`,
                      },
                      isPlaying
                        ? h(Pause, { size: 32, fill: "currentColor" })
                        : h(Play, {
                            size: 32,
                            fill: "currentColor",
                            className: "ml-1",
                          })
                    ),

                    h(
                      "button",
                      {
                        onClick: handleNextStep,
                        disabled:
                          paths.length === 0 || currentStep >= paths.length - 1,
                        className:
                          "p-3 text-stone-600 hover:bg-white hover:shadow-sm rounded-lg transition-all disabled:opacity-30",
                      },
                      h(SkipForward, { size: 24 })
                    )
                  ),

                  h(
                    "div",
                    {
                      className:
                        "px-4 py-2 bg-white rounded-lg border border-stone-200 text-xs font-mono text-stone-500 min-w-[80px] text-center",
                    },
                    paths.length > 0
                      ? `${Math.max(0, currentStep + 1)} / ${paths.length}`
                      : "-- / --"
                  )
                )
              )
            ),
            h(
              "div",
              {
                className:
                  "lg:col-span-2 bg-[#f5f5f4] rounded-2xl shadow-inner flex flex-col items-center justify-center p-8 relative overflow-hidden border border-stone-300 h-full",
              },
              h("div", {
                className:
                  "absolute inset-0 opacity-40 pointer-events-none mix-blend-multiply",
                style: {
                  backgroundImage: `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.5'/%3E%3C/svg%3E")`,
                },
              }),
              paths.length === 0
                ? h(
                    "div",
                    { className: "relative z-10 text-center text-stone-400" },
                    h(Upload, {
                      className: "w-16 h-16 mx-auto mb-4 opacity-30",
                    }),
                    h(
                      "p",
                      { className: "text-lg font-medium" },
                      "等待加载字形"
                    ),
                    h(
                      "p",
                      { className: "text-sm mt-2" },
                      "上传 SVG 文件后将在此处显示预览"
                    )
                  )
                : h(
                    "div",
                    {
                      className:
                        "relative z-10 p-12 transition-all duration-500 transform scale-125 w-full h-full flex items-center justify-center",
                    },
                    h(
                      "svg",
                      {
                        width: parseFloat(svgInfo.width) * 2,
                        height: parseFloat(svgInfo.height) * 2,
                        viewBox: svgInfo.viewBox,
                        className: "overflow-visible",
                        style: {
                          maxWidth: "100%",
                          maxHeight: "100%",
                          width: "auto",
                          height: "auto",
                        },
                      },
                      h(
                        "g",
                        null,
                        paths.map((path, index) => {
                          let status = "waiting";

                          if (currentStep === -1) {
                            status = "idle";
                          } else {
                            if (index < currentStep) status = "completed";
                            else if (index === currentStep)
                              status = "animating";
                            else status = "waiting";
                          }

                          return h(AnimatedPath, {
                            key: path.id,
                            ...path,
                            status: status,
                            isPaused: !isPlaying,
                            recordedStrokeData: recordedStrokes[path.id],
                            totalDurationPerPath: DURATION_PER_PATH,
                            isHovered: hoveredId === path.id,
                            onHover: setHoveredId,
                            onLeave: () => setHoveredId(null),
                          });
                        })
                      )
                    )
                  )
            )
          )
        );
      }

      const root = createRoot(document.getElementById("root"));
      root.render(React.createElement(App));
    </script>
  </body>
</html>
